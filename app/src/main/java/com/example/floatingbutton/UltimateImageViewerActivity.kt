package com.example.floatingbutton

import android.app.Activity
import android.content.Intent
import android.graphics.*
import android.net.Uri
import android.os.Bundle
import android.util.Log
import android.view.View
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.ImageView
import android.widget.Toast
import androidx.core.content.FileProvider
import com.example.floatingbutton.ui.SmartRectangleDrawingView
import com.example.floatingbutton.ui.LiveOCROverlay
import com.example.floatingbutton.ui.FloatingActionMenu
import com.example.floatingbutton.ai.SmartSelectionEngine
import kotlinx.coroutines.*
import java.io.File
import java.io.FileOutputStream
import java.text.SimpleDateFormat
import java.util.*

/**
 * üöÄ Ultimate Image Viewer - A experi√™ncia definitiva de sele√ß√£o inteligente
 * 
 * Caracter√≠sticas:
 * - üî≤ Desenho livre que se completa como ret√¢ngulo
 * - üìù OCR ativo em tempo real sobre o texto
 * - üéØ Texto selecion√°vel como em sites
 * - ‚ú® Anima√ß√µes fluidas e interface moderna
 * - ü§ñ IA integrada para detec√ß√£o inteligente
 * - üìã C√≥pia autom√°tica para clipboard
 */
class UltimateImageViewerActivity : Activity() {

    companion object {
        const val EXTRA_IMAGE_URI = "extra_image_uri"
        private const val TAG = "UltimateImageViewer"
    }

    // üñºÔ∏è Views principais
    private lateinit var mainContainer: FrameLayout
    private lateinit var imageView: ImageView
    private lateinit var smartDrawingView: SmartRectangleDrawingView
    private lateinit var ocrOverlay: LiveOCROverlay
    private lateinit var actionMenu: FloatingActionMenu

    // üñºÔ∏è Dados da imagem
    private var imageUri: Uri? = null
    private var originalBitmap: Bitmap? = null
    private var selectedRegion: RectF? = null

    // ü§ñ IA Engine
    private lateinit var smartSelectionEngine: SmartSelectionEngine
    private var aiAnalysisJob: Job? = null

    // üéØ Estados
    private var currentMode = ViewMode.DRAWING
    
    enum class ViewMode { DRAWING, OCR_ACTIVE, MENU_VISIBLE }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        Log.d(TAG, "üöÄ Iniciando Ultimate Image Viewer...")
        
        setupViews()
        loadImage()
        setupInteractions()
        initializeAI()
        
        showWelcomeHint()
    }

    /**
     * üé® Configura as views com layout moderno
     */
    private fun setupViews() {
        // Container principal com fundo elegante
        mainContainer = FrameLayout(this).apply {
            layoutParams = ViewGroup.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.MATCH_PARENT
            )
            setBackgroundColor(Color.BLACK)
        }

        // ImageView para a imagem de fundo
        imageView = ImageView(this).apply {
            layoutParams = FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.MATCH_PARENT,
                FrameLayout.LayoutParams.MATCH_PARENT
            )
            scaleType = ImageView.ScaleType.FIT_CENTER
        }

        // Smart Drawing View (desenho que vira ret√¢ngulo)
        smartDrawingView = SmartRectangleDrawingView(this).apply {
            layoutParams = FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.MATCH_PARENT,
                FrameLayout.LayoutParams.MATCH_PARENT
            )
        }

        // Live OCR Overlay (texto selecion√°vel)
        ocrOverlay = LiveOCROverlay(this).apply {
            layoutParams = FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.MATCH_PARENT,
                FrameLayout.LayoutParams.MATCH_PARENT
            )
            visibility = View.GONE
        }

        // Menu de a√ß√µes flutuantes
        actionMenu = FloatingActionMenu(this).apply {
            layoutParams = FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.WRAP_CONTENT,
                FrameLayout.LayoutParams.WRAP_CONTENT
            ).apply {
                gravity = android.view.Gravity.END or android.view.Gravity.CENTER_VERTICAL
                marginEnd = 24
            }
            visibility = View.GONE
        }

        // Monta a hierarquia (ordem importa para eventos de toque)
        mainContainer.addView(imageView)
        mainContainer.addView(smartDrawingView)
        mainContainer.addView(ocrOverlay)
        mainContainer.addView(actionMenu)
        
        setContentView(mainContainer)
        
        Log.d(TAG, "‚úÖ Views configuradas com layout elegante")
    }

    /**
     * üñºÔ∏è Carrega a imagem recebida
     */
    private fun loadImage() {
        imageUri = intent.getParcelableExtra(EXTRA_IMAGE_URI)
        
        if (imageUri == null) {
            Log.e(TAG, "‚ùå URI da imagem n√£o fornecida")
            showError("Erro: Imagem n√£o encontrada")
            return
        }

        try {
            contentResolver.openInputStream(imageUri!!)?.use { inputStream ->
                originalBitmap = BitmapFactory.decodeStream(inputStream)
                imageView.setImageBitmap(originalBitmap)
                
                Log.d(TAG, "‚úÖ Imagem carregada: ${originalBitmap?.width}x${originalBitmap?.height}")
            }
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Erro ao carregar imagem: ${e.message}", e)
            showError("Erro ao carregar imagem")
        }
    }

    /**
     * üéØ Configura todas as intera√ß√µes
     */
    private fun setupInteractions() {
        setupDrawingInteractions()
        setupOCRInteractions()
        setupMenuInteractions()
    }

    /**
     * üé® Configura intera√ß√µes de desenho
     */
    private fun setupDrawingInteractions() {
        smartDrawingView.setOnDrawingStartListener {
            Log.d(TAG, "üé® Usu√°rio come√ßou a desenhar")
            hideMenuAndOCR()
            currentMode = ViewMode.DRAWING
        }

        smartDrawingView.setOnRectangleDetectedListener { rect ->
            Log.d(TAG, "üî≤ Ret√¢ngulo detectado: $rect")
            selectedRegion = rect
            
            // Feedback visual
            showToast("üî≤ √Årea retangular detectada!")
        }

        smartDrawingView.setOnSelectionCompleteListener { rect ->
            Log.d(TAG, "‚úÖ Sele√ß√£o completa: $rect")
            selectedRegion = rect
            
            // Mostra menu de a√ß√µes
            showActionMenu()
            currentMode = ViewMode.MENU_VISIBLE
            
            // Inicia an√°lise inteligente em background
            performIntelligentAnalysis(rect)
        }
    }

    /**
     * üìù Configura intera√ß√µes de OCR
     */
    private fun setupOCRInteractions() {
        ocrOverlay.setOnTextSelectedListener { text, mode ->
            val modeText = when (mode) {
                LiveOCROverlay.SelectionMode.WORD -> "palavra"
                LiveOCROverlay.SelectionMode.LINE -> "linha"
                LiveOCROverlay.SelectionMode.BLOCK -> "bloco"
            }
            
            Log.d(TAG, "üìù Texto selecionado ($modeText): $text")
            showToast("üìù $modeText selecionada: \"${text.take(30)}...\"")
        }

        ocrOverlay.setOnOCRCompleteListener { textBlocks ->
            Log.d(TAG, "ü§ñ OCR completo: ${textBlocks.size} blocos detectados")
            
            val totalText = textBlocks.sumOf { it.text.length }
            showToast("üìù OCR conclu√≠do! $totalText caracteres detectados")
            
            // Mostra instru√ß√µes de uso
            showOCRInstructions()
        }
    }

    /**
     * üéØ Configura intera√ß√µes do menu
     */
    private fun setupMenuInteractions() {
        actionMenu.setOnActionClickListener { action ->
            when (action) {
                FloatingActionMenu.Action.OCR -> {
                    activateOCR()
                }
                FloatingActionMenu.Action.SAVE_AREA -> {
                    saveSelectedArea()
                }
                FloatingActionMenu.Action.CROP -> {
                    cropToSelectedArea()
                }
                FloatingActionMenu.Action.SEARCH -> {
                    searchSelectedContent()
                }
                FloatingActionMenu.Action.CLOSE -> {
                    resetToDrawingMode()
                }
            }
        }
    }

    /**
     * ü§ñ Inicializa IA
     */
    private fun initializeAI() {
        try {
            smartSelectionEngine = SmartSelectionEngine(this)
            Log.d(TAG, "ü§ñ IA inicializada com sucesso")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Erro ao inicializar IA: ${e.message}", e)
        }
    }

    /**
     * üí° Mostra dica de boas-vindas
     */
    private fun showWelcomeHint() {
        showToast("‚ú® Desenhe livremente ao redor da √°rea que deseja selecionar")
    }

    /**
     * üìù Ativa modo OCR
     */
    private fun activateOCR() {
        val region = selectedRegion ?: return
        val bitmap = originalBitmap ?: return
        
        Log.d(TAG, "üìù Ativando OCR para regi√£o: $region")
        
        // Esconde menu e mostra OCR overlay
        actionMenu.hideMenu()
        ocrOverlay.visibility = View.VISIBLE
        smartDrawingView.visibility = View.GONE
        
        currentMode = ViewMode.OCR_ACTIVE
        
        // Executa OCR
        showToast("ü§ñ Executando OCR...")
        ocrOverlay.performOCR(bitmap, region)
    }

    /**
     * üß† Executa an√°lise inteligente
     */
    private fun performIntelligentAnalysis(region: RectF) {
        val bitmap = originalBitmap ?: return
        
        aiAnalysisJob?.cancel()
        aiAnalysisJob = CoroutineScope(Dispatchers.Main).launch {
            try {
                showToast("ü§ñ Analisando √°rea selecionada...")
                
                withContext(Dispatchers.Default) {
                    // Simula an√°lise (substitua pela IA real)
                    delay(1000)
                    
                    withContext(Dispatchers.Main) {
                        // Simula resultados
                        val hasText = region.width() > 200 && region.height() > 50
                        if (hasText) {
                            showToast("üìù Texto detectado! Use OCR para extrair")
                        } else {
                            showToast("üñºÔ∏è √Årea de imagem selecionada")
                        }
                    }
                }
                
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Erro na an√°lise: ${e.message}", e)
            }
        }
    }

    /**
     * üñºÔ∏è Salva √°rea selecionada
     */
    private fun saveSelectedArea() {
        val region = selectedRegion ?: return
        val bitmap = originalBitmap ?: return
        
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val croppedBitmap = cropBitmapToRegion(bitmap, region)
                val savedFile = saveBitmapToFile(croppedBitmap)
                
                withContext(Dispatchers.Main) {
                    showToast("‚úÖ √Årea salva: ${savedFile.name}")
                }
                
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    showToast("‚ùå Erro ao salvar √°rea")
                }
            }
        }
    }

    /**
     * ‚úÇÔ∏è Recorta para √°rea selecionada
     */
    private fun cropToSelectedArea() {
        val region = selectedRegion ?: return
        val bitmap = originalBitmap ?: return
        
        try {
            val croppedBitmap = cropBitmapToRegion(bitmap, region)
            imageView.setImageBitmap(croppedBitmap)
            originalBitmap = croppedBitmap
            
            resetToDrawingMode()
            showToast("‚úÇÔ∏è Imagem recortada com sucesso!")
            
        } catch (e: Exception) {
            showToast("‚ùå Erro ao recortar imagem")
        }
    }

    /**
     * üîç Pesquisa conte√∫do selecionado
     */
    private fun searchSelectedContent() {
        showToast("üîç Funcionalidade de pesquisa em desenvolvimento")
        // TODO: Implementar pesquisa
    }

    /**
     * üîÑ Volta para modo de desenho
     */
    private fun resetToDrawingMode() {
        hideMenuAndOCR()
        smartDrawingView.clearSelection()
        smartDrawingView.visibility = View.VISIBLE
        selectedRegion = null
        currentMode = ViewMode.DRAWING
        
        showToast("üé® Modo desenho ativado")
    }

    /**
     * üéØ Mostra menu de a√ß√µes
     */
    private fun showActionMenu() {
        actionMenu.visibility = View.VISIBLE
        actionMenu.showMenu()
    }

    /**
     * ü´• Esconde menu e OCR
     */
    private fun hideMenuAndOCR() {
        actionMenu.hideMenu()
        ocrOverlay.clearOCR()
        ocrOverlay.visibility = View.GONE
    }

    /**
     * üìù Mostra instru√ß√µes do OCR
     */
    private fun showOCRInstructions() {
        showToast("üí° Toque: palavra | Duplo toque: linha | Toque longo: bloco + copiar")
    }

    /**
     * ‚úÇÔ∏è Recorta bitmap para regi√£o
     */
    private fun cropBitmapToRegion(bitmap: Bitmap, region: RectF): Bitmap {
        val x = region.left.toInt().coerceAtLeast(0)
        val y = region.top.toInt().coerceAtLeast(0)
        val width = region.width().toInt().coerceAtMost(bitmap.width - x)
        val height = region.height().toInt().coerceAtMost(bitmap.height - y)
        
        return Bitmap.createBitmap(bitmap, x, y, width, height)
    }

    /**
     * üíæ Salva bitmap em arquivo
     */
    private fun saveBitmapToFile(bitmap: Bitmap): File {
        val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
        val fileName = "selected_area_$timeStamp.jpg"
        
        val file = File(getExternalFilesDir(null), fileName)
        FileOutputStream(file).use { out ->
            bitmap.compress(Bitmap.CompressFormat.JPEG, 90, out)
        }
        
        return file
    }

    /**
     * üí¨ Mostra toast elegante
     */
    private fun showToast(message: String) {
        Toast.makeText(this, message, Toast.LENGTH_SHORT).show()
    }

    /**
     * ‚ùå Mostra erro e fecha
     */
    private fun showError(message: String) {
        Toast.makeText(this, message, Toast.LENGTH_LONG).show()
        finish()
    }

    override fun onBackPressed() {
        when (currentMode) {
            ViewMode.OCR_ACTIVE -> {
                resetToDrawingMode()
            }
            ViewMode.MENU_VISIBLE -> {
                resetToDrawingMode()
            }
            ViewMode.DRAWING -> {
                super.onBackPressed()
            }
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        
        // Cleanup
        aiAnalysisJob?.cancel()
        
        if (::smartSelectionEngine.isInitialized) {
            smartSelectionEngine.cleanup()
        }
        
        originalBitmap?.recycle()
        
        Log.d(TAG, "üßπ Ultimate Image Viewer finalizado")
    }
}
